# 集群构建+mlflow+grafana

[toc]

### 前置步骤

```shell
apt update -y 
```

## 安装kubernetes 
```shell
curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_EXEC="server" INSTALL_K3S_MIRROR=cn sh -s - --disable traefik

cat conf/registries.yaml >> /etc/rancher/k3s/registries.yaml 

#如果显示没有文件不存在则进行创建
# touch /etc/rancher/k3s/registries.yaml 

systemctl daemon-reload 

systemctl restart k3s

# 检查节点是否正常
kubectl get nodes

# 执行下面这段命令后，等到出现三个running才能下一步
watch "kubectl get pod -A"
```

## 创建管理员token
```shell
kubectl create namespace kubernetes-dashboard

# 创建全局管理员token
kubectl apply -f conf/dashboard_admin.yaml

# 获取管理员token
kubectl get secret secret-sa-sample -o=jsonpath='{.data.token}' | base64 --decode
```

## 安装helm

- 安装helm
```shell
./deploy/install_helm.sh
```

若安装失败则根据服务器版本手动下载helm安装包进行安装

- helm加速

```shell
helm repo add bitnami "https://helm-charts.itboon.top/bitnami" --force-update

helm repo add grafana "https://helm-charts.itboon.top/grafana" --force-update

helm repo add prometheus-community "https://helm-charts.itboon.top/prometheus-community" --force-update

helm repo add nginx "https://helm-charts.itboon.top/ingress-nginx" --force-update

helm repo update
```

- helm与k8s进行关联
```shell
kubectl --kubeconfig /etc/rancher/k3s/k3s.yaml get pods --all-namespaces
```

```shell
helm --kubeconfig /etc/rancher/k3s/k3s.yaml ls --all-namespaces
```

```shell
echo "export KUBECONFIG=/etc/rancher/k3s/k3s.yaml" >> ~/.bashrc

source ~/.bashrc
```

## 安装工具组件

```shell
# 安装ingress-nginx
helm install ingress-nginx nginx/ingress-nginx --namespace ingress-nginx --set controller.service.type=LoadBalancer --set controller.ingressClassResource.default=true --set controller.watchIngressWithoutClass=true --create-namespace -f conf/nginx.yaml

# 安装普罗米修斯采集节点数据
helm install prometheus prometheus-community/prometheus -f conf/prometheus.yaml

# 安装grafana监控面板
helm install grafana grafana/grafana -f conf/grafana.yaml

# 注入配置文件
kubectl apply -f conf/mlflow_auth.yaml
kubectl apply -f conf/pgsql_auth.yaml

# 由于需要使用mlflow tracking server托管模型，所以先部署pgsql
helm install postgresql bitnami/postgresql -f conf/pgsql.yaml

# 等都变成running再进行下一步
watch "kubectl get pod -A"

# 安装mlflow
helm install mlflow bitnami/mlflow -f conf/mlflow.yaml

# 要等都变成running才可以下一步
watch "kubectl get pod -A"

# 配置mlflow访问密码
# htpasswd -c auth mlops
kubectl create secret generic mlflow-basic-auth --from-file=auth=conf/conf_auth

# 配置Ingress
kubectl apply -f conf/ingress.yaml

# grafana的密码, 账号是admin
kubectl get secret --namespace default grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo

# 配置Docker镜像的拉取
kubectl create secret docker-registry my-docker-credentials \
  --docker-password=lavendulin777 \
  --docker-username=eevinci
```

## 配置环境变量
```shell
# 查询当前集群中的服务，记录下PGSQL以及mlflow的地址
kubectl get svc

#在集群中运行后端代码
kubectl apply -f deploy/deployment_dataset.yaml

# 添加环境变量
# 只需要改地址即可，账号密码不需要变更
# export TRACKING_URL="http://<mlflow 的svc IP>"
export TRACKING_URL="http://10.43.186.147"
export EXPERIMENT_NAME="training"
export MODEL_NAME="bert"
export BASE_PATH="/root/data"
export MLFLOW_TRACKING_USERNAME=mlops
export MLFLOW_TRACKING_PASSWORD=pPrT33Gh9hdLEcL4GV29
# export DATABASE_URL="postgresql://bn_mlflow:bn_mlflow@<pgsql的 svc ip>/bn_mlflow"
export DATABASE_URL="postgresql://bn_mlflow:bn_mlflow@10.43.196.160/bn_mlflow"

# 第一次初始化，刚安装完东西后，需要先导入一下数据
python3 -m src.import

# 训练三步
python3 -m src.train_pre_csv
python3 -m src.train_embed
python3 -m src.train_svm_gpu

# dataset的使用方法
python3 -m src.dataset

# 请求指定版本的模型并进行预测
# 当预测成功后，会把本次预测输入的内容保存到数据库中
# 当数据库中的数量为100的整数时，会触发训练过程
# 需要至少完成一次训练后才能执行，当中的model_name / model_version都需要按需求改
curl -u admin:123 -X POST localhost:8000/predict -d "{\"model_name\":\"mlops\",\"model_version\":2,\"text\":\"嗯？就这？en ?\"}"  --header "Content-Type: application/json"
# {"create_time":1712671805,"id":23149,"label":"1","source":1,"text":"\u55ef\uff1f\u79d1\u6bd4\u5c31\u8fd9\uff1fen ?"}

# 查看当前托管的全部模型及其版本
curl localhost:8000/models
# [{"name":"bert","versions":[{"creation_time":1712668428998,"description":"","stage":"None","version":"2"}]},{"name":"model","versions":[]}]
# ↑ 像这个就代表着当前有一个名为bert的模型，并且version为2
```

## 安装监控模板
由于Grafana的配置注入总有问题，故需要在安装完之后手动操作一下，操作流程如下：
1. 打开Grafana的后台, 通常为 http://<master节点的IP>/grafan
2. 登录的账号密码在前面`查看密码`部分有相应的命令
3. ![rtd5pd.png](https://mac--img.oss-cn-hangzhou.aliyuncs.com/grafana_dashboard_1.png)
4. ![ynkfcu.png](https://mac--img.oss-cn-hangzhou.aliyuncs.com/ynkfcu.png)
5. ![4fci9y.png](https://mac--img.oss-cn-hangzhou.aliyuncs.com/grafana%20input%20json.png)
6. ![36s4ib.png](https://mac--img.oss-cn-hangzhou.aliyuncs.com/grafana_dashboard_4.png)
7. 在json导入部分，分别将grafana_json中的json文件填入创建，数据源选择Prometheus


## 卸载集群
```shell
/usr/local/bin/k3s-uninstall.sh
```

![image-20240419153146279](https://mac--img.oss-cn-hangzhou.aliyuncs.com/%E7%95%8C%E9%9D%A2%E5%91%88%E7%8E%B0.png)

## 更改grafana管理员密码
```shell
kubectl exec -it <grafana-pod-name> -n default -- /bin/bash
grafana-cli admin reset-admin-password <newpassword>
```